<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
  <head>
    <meta charset="UTF-8">
    <title>Le Grand d&eacute;bat National</title>
    <script src="https://unpkg.com/deck.gl@^6.0.0/deckgl.min.js"></script>
    <style type="text/css">
      body {
        font-family: "Palatino", serif;
        width: 100vw;
        height: 100vh;
        margin: 0;
        background: #FFF;
        position: fixed;
        overflow-y:scroll;
        overflow: hidden;
      }
      .tip {
        line-height: 1;
        font-size: small;
        padding: 12px;
        visibility: hidden;
        background-color: rgba(255, 255, 255, 0.6);
        color: #111;
        border-radius: 0px;
        position: absolute; z-index: 1;
        pointer-events: none;
      }
      .loader {
        width: 100vw;
        height: 100vh;
        line-height: 100vh;
        font-size: 30;
        color: #F00;
        pointer-events: none;
        vertical-align: middle;
      }

    </style>
  </head>

  <body>
    <div id="tooltip" class="tip"></div>
    <div id="loading" class="loader">Chargement des donn√©es en cours, soyez patient.</div>
    <canvas id="deck-canvas"></canvas>
  </body>

  <script type="text/javascript">
    // Get the question set prefix
    url_str = window.location.href
    var url = new URL(url_str);
    var prefix = url.searchParams.get("prefix")

    // Get the question list
    var questions = []
    fetch(prefix + '/' + 'questions.json')
      .then(function(response) { return response.json(); })
      .then(function(data) {
        questions = data
      });

    // Create the deck object
    const {DeckGL, ScatterplotLayer} = deck;

    function color(object) {
        x = object.c / 200 * 255
        return [x, 0, 255-x]
    }

    showTooltip = false
    isFetching = false

    function setTooltip(object, x, y) {
      const el = document.getElementById('tooltip');
      //console.log('t',showTooltip,'f',isFetching)
      if (object) {
        if (isFetching == false) {
          showTooltip = true
          //console.log(x +' ' + y)
          el.style.left = x+10;
          el.style.top = y-10;
          isFetching = true
          fetch('https://storage.googleapis.com/lgdn-eu/'+ prefix + '/' + object.h+'.txt')
          //fetch('./'+ prefix + '/' + object.h+'.txt')
            .then(function(response) {
              return response.text()
            })
            .then(text => {
              if (showTooltip) {
                el.style.visibility = 'visible';
                el.style.display = 'block';
                //el.innerHTML = '<b>' + questions[object.q] +'</b><br>'+ text
                el.innerHTML = text
                //console.log(text.substring(0,20))
                isFetching = false
              }
            })
            .catch(err => {
              isFetching = false
              console.log(err)
            })
          }
        } else {
          //console.log('none',x +' ' + y)
          el.style.display = 'none';
          showTooltip = false
          el.innerHTML = ''
          isFetching = false
      }
    }


    fetch(prefix + '/' + 'data.json')
      .then(function(response) {
        return response.json()
      })
      .then(json => {
        const ell = document.getElementById('loading');
        ell.style.display = 'none';
        new DeckGL({
          longitude: 0,
          latitude: 0,
          zoom: 3,
          maxZoom: 5,
          layers: [
            new ScatterplotLayer({
              id: 'scatter-plot',
              data: json,
              opacity: 0.1,
              pickable: true,
              radiusScale: 500,
              radiusMinPixels: 5,
              getPosition: d => [d.x, d.y, 0],
              getColor: d => color(d),
              onHover: d => setTooltip(d.object, d.x, d.y)
            })
          ]
        });
      })
      .catch(err => {
        isFetching = false
        console.log(err)
      })

  </script>
</html>
